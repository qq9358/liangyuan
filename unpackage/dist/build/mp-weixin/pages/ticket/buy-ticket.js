(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/ticket/buy-ticket"],{"077c":function(t,e,n){"use strict";var i=n("e9a2"),r=n.n(i);r.a},"18f1":function(t,e,n){"use strict";(function(t){n("db7e");i(n("66fd"));var e=i(n("cbef"));function i(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,n("543d")["createPage"])},c148:function(t,e,n){"use strict";var i={customDateSelector:function(){return Promise.all([n.e("common/vendor"),n.e("components/custom/custom-date-selector/custom-date-selector")]).then(n.bind(null,"1261"))},tuiNumberbox:function(){return n.e("components/thorui/tui-numberbox/tui-numberbox").then(n.bind(null,"0c7d"))},customField:function(){return n.e("components/custom/custom-field/custom-field").then(n.bind(null,"7b46"))},ticketTypeDescription:function(){return n.e("components/ticket/ticket-type-description/ticket-type-description").then(n.bind(null,"b6a7"))},uniPopup:function(){return Promise.all([n.e("common/vendor"),n.e("components/uni/uni-popup/uni-popup")]).then(n.bind(null,"6d09"))}},r=function(){var t=this,e=t.$createElement,n=(t._self._c,t.price.toFixed(2));t._isMounted||(t.e0=function(e){t.showDescription=!0},t.e1=function(e){t.showTourist=!1}),t.$mp.data=Object.assign({},{$root:{g0:n}})},u=[];n.d(e,"b",(function(){return r})),n.d(e,"c",(function(){return u})),n.d(e,"a",(function(){return i}))},cbef:function(t,e,n){"use strict";n.r(e);var i=n("c148"),r=n("f312");for(var u in r)"default"!==u&&function(t){n.d(e,t,(function(){return r[t]}))}(u);n("077c");var o,a=n("f0c5"),s=Object(a["a"])(r["default"],i["b"],i["c"],!1,null,"7bd5c56a",null,!1,i["a"],o);e["default"]=s.exports},e21b:function(t,e,n){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=f(n("4795")),r=n("2f62"),u=f(n("4404")),o=f(n("63d4")),a=f(n("8861")),s=f(n("a1ab")),c=f(n("ed00")),l=n("61f5"),d=n("1f1f");function f(t){return t&&t.__esModule?t:{default:t}}function p(t){if("undefined"===typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=h(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,r,u=!0,o=!1;return{s:function(){i=t[Symbol.iterator]()},n:function(){var t=i.next();return u=t.done,t},e:function(t){o=!0,r=t},f:function(){try{u||null==i.return||i.return()}finally{if(o)throw r}}}}function h(t,e){if(t){if("string"===typeof t)return m(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?m(t,e):void 0}}function m(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function y(t,e,n,i,r,u,o){try{var a=t[u](o),s=a.value}catch(c){return void n(c)}a.done?e(s):Promise.resolve(s).then(i,r)}function v(t){return function(){var e=this,n=arguments;return new Promise((function(i,r){var u=t.apply(e,n);function o(t){y(u,i,r,o,a,"next",t)}function a(t){y(u,i,r,o,a,"throw",t)}o(void 0)}))}}function T(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function b(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?T(Object(n),!0).forEach((function(e){g(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):T(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function g(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function k(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var x=function t(){k(this,t),this.name={label:"姓名",vmodel:"",placeholder:"须与证件上的名字一致",validTypeId:6,error:!1},this.mobile={label:"手机号码",vmodel:"",placeholder:"请填写手机号码",validTypeId:3,error:!1},this.certNo={label:"证件号码",vmodel:"",placeholder:"请填写证件号码",validTypeId:6,error:!1}},C={mixins:[l.keyboardPopupMixin,d.mobileMixin],data:function(){return{input:{items:[{ticketTypeId:this.ticketTypeId,quantity:1}],travelDate:"",contactName:{label:"姓名",vmodel:"",placeholder:"须与证件上的名字一致",validTypeId:6,error:!1},contactMobile:{label:"手机号码",vmodel:"",placeholder:"请填写手机号码",validTypeId:3,error:!1},contactCert:{label:"证件号码",vmodel:"",placeholder:"请填写证件号码",validTypeId:6,error:!1}},quantity:1,tourists:[],ticketType:{dailyPrices:[],groundChangCis:[]},minBuyNum:1,maxBuyNum:1e3,showDescription:!1,saving:!1,submited:!1,showTourist:!1,firstTourist:new x,currentTouristIndex:-1,editTourist:{},errorTouristIndex:-1,ticketTypeId:0}},computed:b({refundClass:function(){var t="info";!1===this.ticketType.allowRefund?t="error":this.ticketType.refundLimited&&(t="warning");var e={};return e[t]=!0,e},refundIcon:function(){return!1===this.ticketType.allowRefund?"close":this.ticketType.refundLimited?"info-o":"passed"},refundText:function(){return!1===this.ticketType.allowRefund?"不可退":this.ticketType.refundLimited?"有条件退":"随时退"},price:function(){var t=this,e=this.ticketType.dailyPrices.find((function(e){return e.date==t.input.travelDate})),n=e?e.price:0;return n},totalMoney:function(){return this.price*this.quantity*100},submitText:function(){return this.totalMoney>0?"去支付":"提交订单"},editTouristTitle:function(){return this.editTourist.name||this.editTourist.mobile||this.editTourist.certNo?"编辑":"新增"}},(0,r.mapState)(["promoterId","pageLabelMainText"]),{},(0,r.mapState)("orderModule",["signKey"])),watch:{"input.travelDate":function(){var t=v(i.default.mark((function t(e,n){return i.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n){t.next=2;break}return t.abrupt("return");case 2:if(this.ticketType.hasGroundChangCi){t.next=4;break}return t.abrupt("return");case 4:return t.prev=4,this.loading(),t.next=8,o.default.getTicketTypeChangCiComboboxItemsAsync(this.ticketTypeId,e);case 8:this.ticketType.groundChangCis=t.sent,this.setGroundChangCiDefaultValue();case 10:return t.prev=10,this.loaded(),t.finish(10);case 13:case"end":return t.stop()}}),t,this,[[4,,10,13]])})));function e(e,n){return t.apply(this,arguments)}return e}(),quantity:function(t,e){if(3==this.ticketType.touristInfoType){var n=t-e;if(n>0){for(var i=0;i<n;i++)this.tourists.push(new x);1==t&&(this.firstTourist=this.tourists[0])}else this.tourists.length+=n}}},onLoad:function(t){var e=this;return v(i.default.mark((function n(){var r;return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return e.ticketTypeId=t.ticketTypeId,e.input.items[0].ticketTypeId=t.ticketTypeId,n.prev=2,e.loading(),n.next=6,o.default.getTicketTypeForWeiXinSaleAsync(e.ticketTypeId);case 6:e.ticketType=n.sent,e.ticketType.groundChangCis.forEach((function(t){t.label=t.groundName,t.placeholder="请选择入场时段）",t.validTypeId=9,t.paramSelectDtos=t.changCiDtos.map((function(t){return{displayText:"".concat(t.name,"（").concat(t.stime,":").concat(t.etime,"） 余票：").concat(t.surplusNum),value:t.id.toString(),disabled:!1}}))})),e.minBuyNum=e.ticketType.minBuyNum>1?e.ticketType.minBuyNum:1,e.maxBuyNum=e.ticketType.maxBuyNum>1?e.ticketType.maxBuyNum:1e3,e.quantity=e.minBuyNum,r=e.ticketType.dailyPrices.find((function(t){return!t.disable})),r&&(e.input.travelDate=r.date),e.setGroundChangCiDefaultValue(),3==e.ticketType.touristInfoType&&e.tourists.push(e.firstTourist),e.pageLoaded=!0;case 16:return n.prev=16,e.loaded(),n.finish(16);case 19:case"end":return n.stop()}}),n,null,[[2,,16,19]])})))()},beforeRouteLeave:function(t,e,n){if(this.showTourist)return this.showTourist=!1,void n(!1);this.submited||t.meta.shouldNotConfirm?n():this.$dialog.confirm({title:"确认离开订单填写页？",showCancelButton:!0,confirmButtonText:"离开",cancelButtonText:"取消"}).then((function(){n()})).catch((function(){n(!1)}))},methods:{onQuantityChange:function(t){var e=this;t<this.minBuyNum?this.$nextTick((function(){e.quantity=e.minBuyNum,c.default.noneToast("至少需购买".concat(e.minBuyNum,"份"))})):t>this.maxBuyNum&&this.$nextTick((function(){e.quantity=e.maxBuyNum,c.default.noneToast("最多购买".concat(e.maxBuyNum,"份"))})),this.quantity=t.value},onTouristEdit:function(t){this.currentTouristIndex=t;var e=this.tourists[t];this.editTourist=b({},e),this.$refs.touristPopup.open()},onTouristSave:function(){var t=this;if(this.validateTourist(this.editTourist)){var e=this.tourists.findIndex((function(e){return e.certNo==t.editTourist.certNo}));e>=0&&e!=this.currentTouristIndex?c.default.noneToast("身份证已添加"):(this.tourists[this.currentTouristIndex]=b({},this.editTourist),0==this.currentTouristIndex&&(this.firstTourist=this.tourists[0]),this.$refs.touristPopup.close())}},onSubmit:function(){var t=this;return v(i.default.mark((function e(){var n,r,u,o,a,l,d,f,h;return i.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!(t.ticketType.groundChangCis.length>0)){e.next=19;break}n=p(t.ticketType.groundChangCis),e.prev=2,n.s();case 4:if((r=n.n()).done){e.next=11;break}if(u=r.value,u.changCiId){e.next=9;break}return 1===u.changCis.length&&u.changCis[0].disabled?c.default.noneToast(u.groundName+"暂无可售场次"):c.default.noneToast("请选择"+u.groundName+"场次"),e.abrupt("return");case 9:e.next=4;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e["catch"](2),n.e(e.t0);case 16:return e.prev=16,n.f(),e.finish(16);case 19:if(3!=t.ticketType.touristInfoType){e.next=36;break}o=0;case 21:if(!(o<t.tourists.length)){e.next=29;break}if(a=t.tourists[o],t.validateTourist(a)){e.next=26;break}return t.errorTouristIndex=o,e.abrupt("return");case 26:o++,e.next=21;break;case 29:if(t.errorTouristIndex=-1,t.ticketType.needTouristMobile){e.next=36;break}if(l=[{value:t.input.contactMobile.vmodel,name:"联系手机",rules:[{rule:"required"},{rule:"isMobile"}]}],d=(0,s.default)(l),d.success){e.next=36;break}return c.default.noneToast(d.message),e.abrupt("return");case 36:if(2!=t.ticketType.touristInfoType){e.next=45;break}if(f=[],t.ticketType.needTouristName&&f.push({value:t.input.contactName.vmodel,name:"姓名",rules:[{rule:"required"}]}),t.ticketType.needTouristMobile&&f.push({value:t.input.contactMobile.vmodel,name:"联系手机",rules:[{rule:"required"},{rule:"isMobile"}]}),t.ticketType.needCert&&f.push({value:t.input.contactCert.vmodel,name:"身份证",rules:[{rule:"required"},{rule:"isIdCard"}]}),h=(0,s.default)(f),h.success){e.next=45;break}return c.default.noneToast(h.message),e.abrupt("return");case 45:return t.quantity=Math.max(t.minBuyNum,t.quantity),t.quantity=Math.min(t.maxBuyNum,t.quantity),e.next=49,t.createOrder();case 49:case"end":return e.stop()}}),e,null,[[2,13,16,19]])})))()},setGroundChangCiDefaultValue:function(){!this.ticketType.groundChangCis||this.ticketType.groundChangCis.length<=0||this.ticketType.groundChangCis.forEach((function(t){0==t.changCis.length?t.changCis.push({value:"",displayText:"暂无可售场次",disabled:!0}):1==t.changCis.length&&(t.changCiId=t.changCis[0].value)}))},validateTourist:function(t){var e=[];this.ticketType.needTouristName&&e.push({value:t.name.vmodel,name:"姓名",rules:[{rule:"required"}]}),this.ticketType.needTouristMobile&&e.push({value:t.mobile.vmodel,name:"手机号码",rules:[{rule:"required"},{rule:"isMobile"}]}),this.ticketType.needCert&&e.push({value:t.certNo.vmodel,name:"身份证",rules:[{rule:"required"},{rule:"isIdCard"}]});var n=(0,s.default)(e);return!!n.success||(c.default.noneToast(n.message),!1)},createOrder:function(){var e=this;return v(i.default.mark((function n(){var r,o;return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.prev=0,r={},e.input.items[0].quantity=e.quantity,e.input.items[0].tourists=e.tourists.map((function(t){return{name:t.name.vmodel,mobile:t.mobile.vmodel,certNo:t.certNo.vmodel}})),e.input.items[0].groundChangCis=e.ticketType.groundChangCis.map((function(t){return{groundId:t.groundId,changCiId:t.changCiId}})),r.promoterId=e.promoterId,r.items=e.input.items,r.contactName=e.input.contactName.vmodel,r.contactMobile=e.input.contactMobile.vmodel,r.contactCert=e.input.contactCert.vmodel,r.travelDate=e.input.travelDate,r.sign=(0,u.default)("".concat(r.travelDate).concat(r.items[0].ticketTypeId).concat(r.items[0].quantity).concat(e.signKey)),e.saving=!0,n.next=15,a.default.createWeiXinOrderAsync(r);case 15:o=n.sent,e.submited=!0,o.shouldPay&&t.setStorageSync("Pay:Product",e.ticketType.name),o.shouldPay?t.redirectTo({url:"/pages/payment/wx-js-pay?listNo="+o.listNo}):t.redirectTo({url:"/pages/order/order-detail?listNo="+o.listNo});case 19:return n.prev=19,e.saving=!1,n.finish(19);case 22:case"end":return n.stop()}}),n,null,[[0,,19,22]])})))()},onDescriptionClose:function(){this.showDescription=!1}}};e.default=C}).call(this,n("543d")["default"])},e9a2:function(t,e,n){},f312:function(t,e,n){"use strict";n.r(e);var i=n("e21b"),r=n.n(i);for(var u in i)"default"!==u&&function(t){n.d(e,t,(function(){return i[t]}))}(u);e["default"]=r.a}},[["18f1","common/runtime","common/vendor"]]]);